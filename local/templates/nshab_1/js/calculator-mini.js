jQuery(function(){getServiceList();$("#total-calculate").hide();$("#cm-send-form").hide();$("#calculator-mini").on("change","#cm-service",function(){clearResultMessage();totalSummMiniCalculator();});$("#calculator-mini").on("change","#cm-radius",function(){clearResultMessage();totalSummMiniCalculator();});$("#cm-button-send-form").click(function(){var message=sendMessageMiniCalculator();var email=$("#cm-customer-email").val();if(message!==false){$.ajax({url:'http://thomifelgen.ru/ajax-calculator-send-message.php',type:'POST',cache:false,data:{order:message,cust_email:email},dataType:'json',beforeSend:function(){$('#calculator-main-mini-result').text("Отправка сообщения...").addClass('cm-ajax-loader');},success:function(data){if(data){$('#calculator-main-mini-result').removeClass('cm-ajax-loader');$('#calculator-main-mini-result').text('Спасибо. Ваш заказ отправлен и принят в обработку.');setTimeout(function(){clearForm();},3000);}}});}});$("#calculator-main-mini-send-order").click(function(){var price=parseInt($("#cm-total-summ").text());if(price>0){$("#cm-send-form").show();}else{$("#calculator-main-mini-result").text('Выберите услугу и размер диска').addClass('error');}});$("#calculator-main-mini-disk-count").keyup(function(){$('span.error').remove();var val=$(this).val();var min=1;var max=5;val=val.replace(/\D/g,'');if(parseInt(val)<min||parseInt(val)>max){val=4;$(this).after($('<span/>',{text:' от '+min+' до '+max,class:'error'}));}$(this).val(val);totalSummMiniCalculator();});function clearForm(){$("#cm-send-form input, #cm-send-form textarea").val('');$("#calculator-main-mini-result").text('');$("#cm-radius").val(0);$("#cm-service").val(0);$("#calculator-main-mini-disk-count").val(1);$("#cm-send-form").hide();totalSummMiniCalculator();}function sendMessageMiniCalculator(){var validator=true;$('.cm-form-error').remove();$(".require").each(function(k,v){if($(this).val()===""){$(this).after($("<p/>",{text:"Заполните обязательные поля",class:'cm-form-error'}));validator=false;return false;}else{validator=true;}});if(validator===false){return false;}var body;var diskCount=$("#calculator-main-mini-disk-count").val();var radius=$("#cm-radius option:selected").val();var service=$("#cm-service option:selected").val();body="<p><b>Количество дисков </b> - "+diskCount+"</p>";body+="<p><b>Радиус дисков </b> - "+radius+"</p>";body+="<p><b>Услуга </b> - "+service+"</p>";body+="<p><b>Сумма заказа </b> "+$("#cm-total-summ").text()+" руб.</b></p>";body+="<p><b>ФИО </b>"+$("#cm-customer-name").val()+"</p>";body+="<p><b>Телефон </b>"+$("#cm-customer-phone").val()+"</p>";body+="<p><b>Email </b>"+$("#cm-customer-email").val()+"</p>";body+="<p><b>Сообщение </b>"+$("#cm-customer-message").val()+"</p>";return body;}function clearResultMessage(){$("#calculator-main-mini-result").text('').removeClass('error');}function getServiceList(){$.ajax({url:'http://thomifelgen.ru/ajax-calculator-mini.php',type:'POST',cache:false,data:{},dataType:'json',success:function(data){console.log(data);renderCalculator(data);}});}function renderCalculator(data){var selectRadius=$('<select/>',{id:'cm-radius'}).append($('<option/>',{text:"Выберите диаметр диска",value:0}));var r=13;while(r<=26){var name="R"+r;var option=$('<option/>',{text:name,id:name,radius:r});selectRadius.append(option);r++;};var selectService=$('<select/>',{id:'cm-service'}).append($('<option/>',{text:"Выберите услугу",value:0}));$.each(data,function(key,value){var option=$('<option/>',{text:value['NAME'],id:key}).data({'prices':value['Property']});selectService.append(option);});$("#calculator-mini").append($("<p/>").append(selectRadius),$("<p/>").append(selectService));}function totalSummMiniCalculator(){var radius=$("#cm-radius option:selected").attr('radius');var prices=$("#cm-service option:selected").data('prices');var totalPrice=0;if(radius!==undefined&&prices!==undefined){var price_key="cm_price_"+radius;var priceRadius=prices[price_key];var price=prices["cm_price"];if(priceRadius===null&&price===null){totalPrice=0;}else if(priceRadius===null){totalPrice=price;}else{totalPrice=priceRadius;}}var count=parseInt($("#calculator-main-mini-disk-count").val());totalPrice=totalPrice*count;$("#cm-total-summ").text(totalPrice);$("#cm-total-summ-down").text(totalPrice);if(totalPrice>0){$("#total-calculate").show();}else{$("#total-calculate").hide();$("#cm-send-form").hide();}}});